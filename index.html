<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSC | Centro de Serviços Compartilhados - Geórgia Contábil</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <meta name="description" content="Sistema de Gestão de Chamados - Centro de Serviços Compartilhados">
    <meta name="theme-color" content="#1e293b">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen" class="loading-screen">
        <div class="loading-content">
            <div class="brand-logo">
                <i class="fas fa-headset"></i>
            </div>
            <h2>CSC Geórgia Contábil</h2>
            <p>Carregando...</p>
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- Authentication Screen -->
    <div id="auth-screen" class="auth-screen" style="display: none;">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <div class="brand-logo">
                        <i class="fas fa-headset"></i>
                    </div>
                    <h1>CSC Geórgia Contábil</h1>
                    <p>Centro de Serviços Compartilhados</p>
                </div>
                
                <div class="auth-content">
                    <div class="auth-info">
                        <h3>Bem-vindo ao CSC</h3>
                        <p>Acesse o sistema de gestão de chamados com sua conta Microsoft corporativa.</p>
                        
                        <div class="auth-features">
                            <div class="feature">
                                <i class="fas fa-shield-alt"></i>
                                <span>Autenticação Segura</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-ticket-alt"></i>
                                <span>Gestão de Chamados</span>
                            </div>
                            <div class="feature">
                                <i class="fas fa-chart-line"></i>
                                <span>Relatórios Avançados</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="auth-actions">
                        <button id="login-btn" class="btn btn-primary btn-lg" onclick="window.location.href='/auth/login'">
                            <i class="fab fa-microsoft"></i>
                            Entrar com Microsoft
                        </button>
                        
                        <div class="auth-domains">
                            <p>Domínios autorizados:</p>
                            <div class="domain-tags">
                                <span class="domain-tag">@georgiacontabil.com.br</span>
                                <span class="domain-tag">@nine9.com.br</span>
                                <span class="domain-tag">ryan31624@gmail.com</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="app" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="container">
                <div class="header-content">
                    <div class="brand">
                        <div class="brand-logo">
                            <i class="fas fa-headset"></i>
                        </div>
                        <div>
                            <div class="brand-name">CSC Geórgia Contábil</div>
                            <div class="brand-subtitle">Centro de Serviços Compartilhados</div>
                        </div>
                    </div>

                    <nav class="nav">
                        <div class="nav-item" data-view="dashboard">
                            <i class="fas fa-tachometer-alt icon"></i>
                            <span>Dashboard</span>
                        </div>
                        <div class="nav-item" data-view="tickets">
                            <i class="fas fa-ticket-alt icon"></i>
                            <span>Chamados</span>
                        </div>
                        <div class="nav-item admin-only" data-view="admin" style="display: none;">
                            <i class="fas fa-cog icon"></i>
                            <span>Administração</span>
                        </div>
                        <div class="nav-item admin-only" data-view="reports" style="display: none;">
                            <i class="fas fa-chart-bar icon"></i>
                            <span>Relatórios</span>
                        </div>
                    </nav>

                    <div class="user-info">
                        <div class="notifications">
                            <button class="btn btn-secondary btn-sm" id="notifications-btn">
                                <i class="fas fa-bell"></i>
                                <span class="notification-badge" style="display: none;">0</span>
                            </button>
                        </div>
                        
                        <div class="user-avatar" id="user-avatar">
                            <span id="user-initials">U</span>
                        </div>
                        
                        <div class="user-details">
                            <div class="user-name" id="user-name">Usuário</div>
                            <div class="user-role" id="user-role">Usuário</div>
                        </div>
                        
                        <div class="user-menu">
                            <button class="btn btn-secondary btn-sm" id="user-menu-btn">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main">
            <div class="container">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="view">
                    <div class="page-header">
                        <h1>Dashboard</h1>
                        <p>Visão geral do sistema e estatísticas</p>
                    </div>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">
                                <i class="fas fa-ticket-alt"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value" id="total-tickets">0</div>
                                <div class="stat-label">Total de Chamados</div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon warning">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value" id="open-tickets">0</div>
                                <div class="stat-label">Chamados Abertos</div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon success">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value" id="closed-tickets">0</div>
                                <div class="stat-label">Chamados Fechados</div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon info">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-content">
                                <div class="stat-value" id="total-users">0</div>
                                <div class="stat-label">Usuários Ativos</div>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <h3>Chamados por Área</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="area-chart"></canvas>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3>Chamados por Status</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="status-chart"></canvas>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3>Chamados Recentes</h3>
                            </div>
                            <div class="recent-tickets" id="recent-tickets">
                                <!-- Recent tickets will be loaded here -->
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3>Atividade do Sistema</h3>
                            </div>
                            <div class="activity-log" id="activity-log">
                                <!-- Activity log will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tickets View -->
                <div id="tickets-view" class="view" style="display: none;">
                    <div class="page-header">
                        <div class="page-title">
                            <h1>Gestão de Chamados</h1>
                            <p>Gerencie e acompanhe todos os chamados do sistema</p>
                        </div>
                        <div class="page-actions">
                            <button class="btn btn-primary" id="new-ticket-btn">
                                <i class="fas fa-plus"></i>
                                Novo Chamado
                            </button>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="filters-card">
                        <div class="filters-grid">
                            <div class="form-group">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="status-filter">
                                    <option value="">Todos</option>
                                    <option value="ABERTO">Aberto</option>
                                    <option value="EM_ANALISE">Em Análise</option>
                                    <option value="AGUARDANDO">Aguardando</option>
                                    <option value="RESOLVIDO">Resolvido</option>
                                    <option value="FECHADO">Fechado</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Área</label>
                                <select class="form-select" id="area-filter">
                                    <option value="">Todas</option>
                                    <option value="TI">TI</option>
                                    <option value="RH">RH</option>
                                    <option value="Financeiro">Financeiro</option>
                                    <option value="Comercial">Comercial</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Prioridade</label>
                                <select class="form-select" id="priority-filter">
                                    <option value="">Todas</option>
                                    <option value="LOW">Baixa</option>
                                    <option value="MEDIUM">Média</option>
                                    <option value="HIGH">Alta</option>
                                    <option value="CRITICAL">Crítica</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Buscar</label>
                                <input type="text" class="form-input" id="search-filter" placeholder="Buscar chamados...">
                            </div>
                        </div>
                    </div>

                    <!-- Tickets Table -->
                    <div class="card">
                        <div class="card-header">
                            <h3>Chamados</h3>
                            <div class="table-actions">
                                <button class="btn btn-secondary btn-sm" id="refresh-btn">
                                    <i class="fas fa-sync-alt"></i>
                                    Atualizar
                                </button>
                            </div>
                        </div>
                        <div class="table-container">
                            <table class="table" id="tickets-table">
                                <thead>
                                    <tr>
                                        <th>Número</th>
                                        <th>Título</th>
                                        <th>Área</th>
                                        <th>Status</th>
                                        <th>Prioridade</th>
                                        <th>Solicitante</th>
                                        <th>Responsável</th>
                                        <th>Data</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="tickets-tbody">
                                    <!-- Tickets will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="tickets-pagination">
                            <!-- Pagination will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Admin View -->
                <div id="admin-view" class="view" style="display: none;">
                    <div class="page-header">
                        <h1>Administração</h1>
                        <p>Gerencie usuários, configurações e monitoramento do sistema</p>
                    </div>

                    <div class="admin-grid">
                        <div class="card">
                            <div class="card-header">
                                <h3>Usuários</h3>
                                <button class="btn btn-primary btn-sm" id="add-user-btn">
                                    <i class="fas fa-plus"></i>
                                    Adicionar
                                </button>
                            </div>
                            <div class="table-container">
                                <table class="table" id="users-table">
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Email</th>
                                            <th>Função</th>
                                            <th>Departamento</th>
                                            <th>Status</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-tbody">
                                        <!-- Users will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3>Configurações do Sistema</h3>
                            </div>
                            <div class="settings-form" id="settings-form">
                                <!-- Settings will be loaded here -->
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3>Logs de Auditoria</h3>
                            </div>
                            <div class="audit-logs" id="audit-logs">
                                <!-- Audit logs will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports View -->
                <div id="reports-view" class="view" style="display: none;">
                    <div class="page-header">
                        <h1>Relatórios</h1>
                        <p>Gere relatórios detalhados e exporte dados</p>
                    </div>

                    <div class="reports-grid">
                        <div class="card">
                            <div class="card-header">
                                <h3>Relatório de Chamados</h3>
                                <div class="report-actions">
                                    <button class="btn btn-success btn-sm" id="export-excel-btn">
                                        <i class="fas fa-file-excel"></i>
                                        Excel
                                    </button>
                                    <button class="btn btn-secondary btn-sm" id="export-csv-btn">
                                        <i class="fas fa-file-csv"></i>
                                        CSV
                                    </button>
                                </div>
                            </div>
                            <div class="report-filters">
                                <div class="filters-grid">
                                    <div class="form-group">
                                        <label class="form-label">Data Início</label>
                                        <input type="date" class="form-input" id="start-date">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Data Fim</label>
                                        <input type="date" class="form-input" id="end-date">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Área</label>
                                        <select class="form-select" id="report-area-filter">
                                            <option value="">Todas</option>
                                            <option value="TI">TI</option>
                                            <option value="RH">RH</option>
                                            <option value="Financeiro">Financeiro</option>
                                            <option value="Comercial">Comercial</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Status</label>
                                        <select class="form-select" id="report-status-filter">
                                            <option value="">Todos</option>
                                            <option value="ABERTO">Aberto</option>
                                            <option value="FECHADO">Fechado</option>
                                        </select>
                                    </div>
                                </div>
                                <button class="btn btn-primary" id="generate-report-btn">
                                    <i class="fas fa-chart-bar"></i>
                                    Gerar Relatório
                                </button>
                            </div>
                            <div class="report-content" id="report-content">
                                <!-- Report content will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- New Ticket Modal -->
    <div id="new-ticket-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>Novo Chamado</h3>
                <button class="modal-close" id="close-new-ticket-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="new-ticket-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Título *</label>
                            <input type="text" class="form-input" id="ticket-title" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Área *</label>
                            <select class="form-select" id="ticket-area" required>
                                <option value="">Selecione uma área</option>
                                <option value="TI">TI</option>
                                <option value="RH">RH</option>
                                <option value="Financeiro">Financeiro</option>
                                <option value="Comercial">Comercial</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Quadro *</label>
                            <select class="form-select" id="ticket-board" required>
                                <option value="">Selecione um quadro</option>
                                <option value="Incidentes">Incidentes</option>
                                <option value="Solicitações">Solicitações</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Prioridade</label>
                            <select class="form-select" id="ticket-priority">
                                <option value="MEDIUM">Média</option>
                                <option value="LOW">Baixa</option>
                                <option value="HIGH">Alta</option>
                                <option value="CRITICAL">Crítica</option>
                            </select>
                        </div>
                        
                        <div class="form-group full-width">
                            <label class="form-label">Descrição *</label>
                            <textarea class="form-textarea" id="ticket-description" rows="4" required 
                                      placeholder="Descreva detalhadamente o problema ou solicitação..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Data de Vencimento</label>
                            <input type="datetime-local" class="form-input" id="ticket-due-date">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-new-ticket">Cancelar</button>
                <button class="btn btn-primary" id="submit-new-ticket">
                    <i class="fas fa-save"></i>
                    Criar Chamado
                </button>
            </div>
        </div>
    </div>

    <!-- Ticket Detail Modal -->
    <div id="ticket-detail-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content large">
            <div class="modal-header">
                <h3>Detalhes do Chamado</h3>
                <button class="modal-close" id="close-ticket-detail-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="ticket-detail-content">
                    <!-- Ticket details will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Modal -->
    <div id="notifications-modal" class="modal" style="display: none;">
        <div class="modal-overlay"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>Notificações</h3>
                <button class="modal-close" id="close-notifications-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="notifications-content">
                    <!-- Notifications will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.4/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/public/client.js"></script>
    <script>
        // Main Application Logic
        class CSCApp {
            constructor() {
                this.currentView = 'dashboard';
                this.currentUser = null;
                this.init();
            }

            async init() {
                try {
                    // Check authentication
                    this.currentUser = await window.CSC.fetchMe();
                    
                    if (!this.currentUser) {
                        this.showAuthScreen();
                        return;
                    }

                    this.showApp();
                    this.setupEventListeners();
                    this.loadDashboard();
                    
                    // Initialize WebSocket
                    window.CSC.initSocket(this.currentUser.id);
                    
                } catch (error) {
                    console.error('Initialization error:', error);
                    this.showAuthScreen();
                }
            }

            showAuthScreen() {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('auth-screen').style.display = 'block';
                document.getElementById('app').style.display = 'none';
            }

            showApp() {
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                
                this.updateUserInfo();
                this.setupNavigation();
            }

            updateUserInfo() {
                const user = this.currentUser;
                
                // Update user display
                document.getElementById('user-name').textContent = user.name;
                document.getElementById('user-role').textContent = this.getRoleDisplay(user.role);
                document.getElementById('user-initials').textContent = this.getInitials(user.name);
                
                // Show admin features if applicable
                if (user.role === 'SUPER_ADMIN' || user.role === 'ADMIN') {
                    document.querySelectorAll('.admin-only').forEach(el => {
                        el.style.display = 'flex';
                    });
                }
            }

            getRoleDisplay(role) {
                const roles = {
                    'SUPER_ADMIN': 'Super Administrador',
                    'ADMIN': 'Administrador',
                    'MANAGER': 'Gerente',
                    'USER': 'Usuário',
                    'VIEWER': 'Visualizador'
                };
                return roles[role] || role;
            }

            getInitials(name) {
                return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
            }

            setupNavigation() {
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const view = item.dataset.view;
                        this.switchView(view);
                    });
                });
            }

            switchView(view) {
                // Hide all views
                document.querySelectorAll('.view').forEach(v => {
                    v.style.display = 'none';
                });
                
                // Show selected view
                document.getElementById(`${view}-view`).style.display = 'block';
                
                // Update navigation
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                document.querySelector(`[data-view="${view}"]`).classList.add('active');
                
                this.currentView = view;
                
                // Load view content
                switch (view) {
                    case 'dashboard':
                        this.loadDashboard();
                        break;
                    case 'tickets':
                        this.loadTickets();
                        break;
                    case 'admin':
                        this.loadAdmin();
                        break;
                    case 'reports':
                        this.loadReports();
                        break;
                }
            }

            setupEventListeners() {
                // New ticket button
                document.getElementById('new-ticket-btn').addEventListener('click', () => {
                    this.showNewTicketModal();
                });

                // Modal close buttons
                document.getElementById('close-new-ticket-modal').addEventListener('click', () => {
                    this.hideNewTicketModal();
                });

                // Form submissions
                document.getElementById('submit-new-ticket').addEventListener('click', () => {
                    this.submitNewTicket();
                });

                // Notifications
                document.getElementById('notifications-btn').addEventListener('click', () => {
                    this.showNotificationsModal();
                });
            }

            async loadDashboard() {
                try {
                    const stats = await window.CSC.getTicketStats();
                    this.updateDashboardStats(stats);
                    this.loadRecentTickets();
                } catch (error) {
                    console.error('Error loading dashboard:', error);
                }
            }

            updateDashboardStats(stats) {
                document.getElementById('total-tickets').textContent = stats.totalTickets || 0;
                document.getElementById('open-tickets').textContent = stats.openTickets || 0;
                document.getElementById('closed-tickets').textContent = stats.closedTickets || 0;
                document.getElementById('total-users').textContent = stats.totalUsers || 0;
            }

            async loadRecentTickets() {
                try {
                    const tickets = await window.CSC.fetchTickets({ limit: 5 });
                    this.renderRecentTickets(tickets);
                } catch (error) {
                    console.error('Error loading recent tickets:', error);
                }
            }

            renderRecentTickets(tickets) {
                const container = document.getElementById('recent-tickets');
                if (!tickets.length) {
                    container.innerHTML = '<p class="text-muted">Nenhum chamado recente.</p>';
                    return;
                }

                container.innerHTML = tickets.map(ticket => `
                    <div class="recent-ticket">
                        <div class="ticket-info">
                            <div class="ticket-number">#${ticket.ticket_number}</div>
                            <div class="ticket-title">${ticket.title}</div>
                            <div class="ticket-meta">
                                <span class="ticket-area">${ticket.area}</span>
                                <span class="ticket-status status-${ticket.status.toLowerCase()}">${ticket.status}</span>
                            </div>
                        </div>
                        <div class="ticket-date">
                            ${window.CSC.formatDate(ticket.created_at)}
                        </div>
                    </div>
                `).join('');
            }

            async loadTickets() {
                try {
                    const tickets = await window.CSC.fetchTickets();
                    this.renderTicketsTable(tickets);
                } catch (error) {
                    console.error('Error loading tickets:', error);
                }
            }

            renderTicketsTable(tickets) {
                const tbody = document.getElementById('tickets-tbody');
                
                if (!tickets.length) {
                    tbody.innerHTML = '<tr><td colspan="9" class="text-center">Nenhum chamado encontrado.</td></tr>';
                    return;
                }

                tbody.innerHTML = tickets.map(ticket => `
                    <tr>
                        <td><strong>#${ticket.ticket_number}</strong></td>
                        <td>${ticket.title}</td>
                        <td>${ticket.area}</td>
                        <td><span class="badge status-${ticket.status.toLowerCase()}">${ticket.status}</span></td>
                        <td><span class="badge priority-${ticket.priority.toLowerCase()}">${ticket.priority}</span></td>
                        <td>${ticket.requester_name}</td>
                        <td>${ticket.assignee_name || '-'}</td>
                        <td>${window.CSC.formatDate(ticket.created_at)}</td>
                        <td>
                            <div class="table-actions">
                                <button class="btn btn-secondary btn-sm" onclick="app.viewTicket(${ticket.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${this.currentUser.canAssign ? `
                                    <button class="btn btn-primary btn-sm" onclick="app.assignTicket(${ticket.id})">
                                        <i class="fas fa-user-plus"></i>
                                    </button>
                                ` : ''}
                                ${this.currentUser.canAssign && ticket.status !== 'FECHADO' ? `
                                    <button class="btn btn-success btn-sm" onclick="app.closeTicket(${ticket.id})">
                                        <i class="fas fa-check"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            showNewTicketModal() {
                document.getElementById('new-ticket-modal').style.display = 'block';
            }

            hideNewTicketModal() {
                document.getElementById('new-ticket-modal').style.display = 'none';
                document.getElementById('new-ticket-form').reset();
            }

            async submitNewTicket() {
                const form = document.getElementById('new-ticket-form');
                const formData = new FormData(form);
                
                const ticketData = {
                    title: document.getElementById('ticket-title').value,
                    description: document.getElementById('ticket-description').value,
                    area: document.getElementById('ticket-area').value,
                    board: document.getElementById('ticket-board').value,
                    priority: document.getElementById('ticket-priority').value,
                    due_date: document.getElementById('ticket-due-date').value || null
                };

                try {
                    await window.CSC.createTicket(ticketData);
                    window.CSC.showToast('Chamado criado com sucesso!', 'success');
                    this.hideNewTicketModal();
                    this.loadTickets();
                } catch (error) {
                    window.CSC.showToast(error.message, 'error');
                }
            }

            async loadAdmin() {
                try {
                    const users = await window.CSC.fetchUsers();
                    this.renderUsersTable(users.users);
                    
                    const settings = await window.CSC.getSettings();
                    this.renderSettings(settings.settings);
                } catch (error) {
                    console.error('Error loading admin data:', error);
                }
            }

            renderUsersTable(users) {
                const tbody = document.getElementById('users-tbody');
                
                tbody.innerHTML = users.map(user => `
                    <tr>
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td><span class="badge">${this.getRoleDisplay(user.role)}</span></td>
                        <td>${user.department || '-'}</td>
                        <td>
                            <span class="badge ${user.is_active ? 'badge-success' : 'badge-error'}">
                                ${user.is_active ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="app.editUser('${user.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');
            }

            renderSettings(settings) {
                const container = document.getElementById('settings-form');
                
                container.innerHTML = settings.map(setting => `
                    <div class="form-group">
                        <label class="form-label">${setting.description}</label>
                        <input type="text" class="form-input" value="${setting.setting_value}" 
                               onchange="app.updateSetting('${setting.setting_key}', this.value)">
                    </div>
                `).join('');
            }

            async loadReports() {
                // Reports view will be implemented here
                console.log('Loading reports...');
            }

            showNotificationsModal() {
                document.getElementById('notifications-modal').style.display = 'block';
                this.loadNotifications();
            }

            async loadNotifications() {
                try {
                    const notifications = await window.CSC.fetchNotifications();
                    this.renderNotifications(notifications.notifications);
                } catch (error) {
                    console.error('Error loading notifications:', error);
                }
            }

            renderNotifications(notifications) {
                const container = document.getElementById('notifications-content');
                
                if (!notifications.length) {
                    container.innerHTML = '<p class="text-muted">Nenhuma notificação.</p>';
                    return;
                }

                container.innerHTML = notifications.map(notification => `
                    <div class="notification-item ${notification.is_read ? 'read' : 'unread'}">
                        <div class="notification-content">
                            <div class="notification-title">${notification.title}</div>
                            <div class="notification-message">${notification.message}</div>
                            <div class="notification-time">${window.CSC.formatDate(notification.created_at)}</div>
                        </div>
                        ${!notification.is_read ? `
                            <button class="btn btn-secondary btn-sm" onclick="app.markNotificationAsRead(${notification.id})">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : ''}
                    </div>
                `).join('');
            }

            async markNotificationAsRead(id) {
                try {
                    await window.CSC.markNotificationAsRead(id);
                    this.loadNotifications();
                    window.CSC.updateNotificationBadge();
                } catch (error) {
                    console.error('Error marking notification as read:', error);
                }
            }

            async updateSetting(key, value) {
                try {
                    await window.CSC.updateSetting(key, value);
                    window.CSC.showToast('Configuração atualizada com sucesso!', 'success');
                } catch (error) {
                    window.CSC.showToast('Erro ao atualizar configuração', 'error');
                }
            }
        }

        // Initialize app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new CSCApp();
        });
    </script>
</body>
</html>